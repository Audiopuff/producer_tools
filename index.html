<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cybernetic Audio Optimization System</title>
    <style type="text/css">
        /* 1995-style page */
        body {
            background-color: #C0C0C0;
            color: #000000;
            font-family: "Courier New", Courier, monospace;
            font-size: 12pt;
            margin: 0;
            padding: 0;
        }
        a:link   { color: #0000FF; text-decoration: underline; }
        a:visited{ color: #800080; text-decoration: underline; }
        a:active { color: #FF0000; text-decoration: underline; }
        table.main {
            width: 800px;
            border: 2px ridge #808080;
            background-color: #FFFFFF;
            margin: 20px auto;
        }
        td.section {
            padding: 8px;
            border-bottom: 1px solid #000000;
        }
        h1 {
            font-size: 18pt;
            color: #000080;
            margin: 8px 0;
        }
        h2 {
            font-size: 14pt;
            color: #000080;
            margin: 8px 0;
        }
        hr {
            border: 1px solid #000000;
        }
        marquee {
            background-color: #FFFF00;
            color: #000000;
            font-weight: bold;
        }
        input, select, textarea, button {
            font-family: "Courier New", Courier, monospace;
            font-size: 12pt;
            margin: 4px 0;
        }
        .note {
            font-size: 10pt;
            color: #800000;
        }

        /* ‚Äî‚Äî New Animated Audio Graphic ‚Äî‚Äî */
        .emoji-eq {
            text-align: center;
            font-size: 2.5em;
            margin: 40px auto 20px;
        }
        .emoji-eq span {
            display: inline-block;
            animation: bounce 0.8s ease-in-out infinite;
        }
        .emoji-eq span:nth-child(1) { animation-delay: 0s; }
        .emoji-eq span:nth-child(2) { animation-delay: 0.2s; }
        .emoji-eq span:nth-child(3) { animation-delay: 0.4s; }
        .emoji-eq span:nth-child(4) { animation-delay: 0.6s; }
        .emoji-eq span:nth-child(5) { animation-delay: 0.8s; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50%      { transform: translateY(-20px); }
        }

        .ascii-bars {
            text-align: center;
            font-family: monospace;
            font-size: 1.5em;
            line-height: 1;
            margin-bottom: 60px;
        }
        .ascii-bars span {
            display: inline-block;
            transform-origin: bottom;
            animation: pulse 1.2s ease-in-out infinite;
        }
        .ascii-bars span:nth-child(odd)  { animation-delay: 0.1s; }
        .ascii-bars span:nth-child(even) { animation-delay: 0.3s; }

        @keyframes pulse {
            0%, 100% { transform: scaleY(0.5); }
            50%      { transform: scaleY(1.5); }
        }
    </style>
</head>
<body text="#000000" link="#0000FF" vlink="#800080" alink="#FF0000">
    <center>
        <marquee behavior="alternate" scrollamount="4">Welcome to the Future!</marquee>
        <table class="main" cellspacing="0" cellpadding="0">
            <tr><td class="section" align="center">
                <h1>Cybernetic Audio Optimization System</h1>
            </td></tr>
            <tr><td class="section">
                <h2>How to Use</h2>
                <ul>
                    <li>This system works best with music containing bass, drums, and vocals.</li>
                    <li>MP3 and WAV files only.</li>
                    <li>Processing takes about 10 minutes per 1 minute of music.</li>
                    <li>Keep this browser window open during processing.</li>
                </ul>
                <p class="note"><b></b></p>
            </td></tr>
            <tr><td class="section">
                <h2>Upload Audio File</h2>
                <form id="uploadForm">
                    <table cellspacing="0" cellpadding="2">
                        <tr><td><b>Audio File (MP3 or WAV):</b></td></tr>
                        <tr><td><input type="file" id="audioFile" accept=".mp3,.wav,.flac,.aif,.aiff" required></td></tr>
                        <tr><td><input type="submit" value="Upload and Process"></td></tr>
                    </table>
                </form>
            </td></tr>
            <tr><td class="section">
                <div id="statusContainer">
                    <p id="statusMessage"></p>
                    <p id="processingStage"></p>
                </div>
            </td></tr>
            <tr><td class="section">
                <div id="resultContainer" style="display: none;">
                    <h2>Processed Audio</h2>
                    <p>Click the link below to download your file:</p>
                    <a id="downloadLink" href="#" download="processed_audio.wav">Download Processed Audio</a>
                </div>
            </td></tr>
        </table>

        <!-- Animated Audio Graphic -->
        <div class="emoji-eq">
            <span>üîä</span>
            <span>üéµ</span>
            <span>üîà</span>
            <span>üé∂</span>
            <span>üîâ</span>
        </div>
        <div class="ascii-bars">
            <span>‚ñÅ</span><span>‚ñÇ</span><span>‚ñÉ</span><span>‚ñÑ</span>
            <span>‚ñÖ</span><span>‚ñÜ</span><span>‚ñá</span><span>‚ñà</span>
            <span>‚ñá</span><span>‚ñÜ</span><span>‚ñÖ</span><span>‚ñÑ</span>
            <span>‚ñÉ</span><span>‚ñÇ</span><span>‚ñÅ</span>
        </div>
    </center>

    <script>
        /* (JavaScript unchanged to preserve full functionality) */
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const uploadButton = uploadForm.querySelector('input[type="submit"]');
            const statusMessage = document.getElementById('statusMessage');
            const processingStage = document.getElementById('processingStage');
            const resultContainer = document.getElementById('resultContainer');
            const audioFileInput = document.getElementById('audioFile');
            const progressBarContainer = document.createElement('div');
            const progressBar = document.createElement('div');

            progressBarContainer.style.width = '100%';
            progressBarContainer.style.backgroundColor = '#FFFFFF';
            progressBarContainer.style.border = '1px solid #000000';
            progressBarContainer.style.height = '20px';
            progressBarContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.style.height = '100%';
            progressBar.style.backgroundColor = '#000080';
            progressBar.style.color = '#FFFFFF';
            progressBar.style.textAlign = 'center';
            progressBar.style.fontSize = '10pt';
            progressBarContainer.appendChild(progressBar);
            uploadForm.appendChild(progressBarContainer);

            const backendBaseUrl = window.TRIGGER_SERVICE_URL || 'https://apmainrefac-1053060340132.us-central1.run.app/';
            const initiateUrl = backendBaseUrl + 'initiate_upload';
            const finalizeUrl = backendBaseUrl + 'finalize_upload';
            const statusUrlBase = backendBaseUrl + 'status/';
            const downloadUrlBase = backendBaseUrl + 'download/';

            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                resetUI();
                const file = audioFileInput.files[0];
                if (!file) { statusMessage.textContent = 'Please select an audio file.'; return; }
                uploadButton.disabled = true;
                uploadButton.value = 'Starting Upload...';
                progressBarContainer.style.display = 'block';
                statusMessage.textContent = 'Initiating upload...';

                const filename = file.name;
                const contentType = file.type || 'application/octet-stream';

                try {
                    const initRes = await fetch(initiateUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename, contentType }),
                    });
                    if (!initRes.ok) throw new Error('Failed to initiate upload');
                    const { jobId, signedUrl, gcsPath } = await initRes.json();
                    statusMessage.textContent = `Uploading ${filename}...`;

                    await uploadDirectlyToGCS(jobId, signedUrl, file, contentType);

                    statusMessage.textContent = 'Upload complete. Finalizing...';
                    progressBar.style.width = '100%';
                    progressBar.textContent = 'Finalizing...';

                    const finRes = await fetch(finalizeUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ jobId, gcsPath, originalFilename: filename }),
                    });
                    if (!finRes.ok) throw new Error('Failed to finalize upload');
                    statusMessage.textContent = 'Processing started...';
                    processingStage.textContent = 'Queued';

                    pollProcessingStatus(jobId);
                } catch (err) {
                    statusMessage.textContent = `Error: ${err.message}`;
                    resetUploadButton();
                    progressBarContainer.style.display = 'none';
                }
            });

            function uploadDirectlyToGCS(jobId, url, file, contentType) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', url, true);
                    xhr.setRequestHeader('Content-Type', contentType);
                    xhr.upload.onprogress = e => {
                        if (e.lengthComputable) {
                            const pct = Math.round((e.loaded / e.total) * 100) + '%';
                            progressBar.style.width = pct;
                            progressBar.textContent = pct;
                        }
                    };
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) resolve();
                        else reject(new Error(`GCS upload failed: ${xhr.status}`));
                    };
                    xhr.onerror = () => reject(new Error('Network error during GCS upload.'));
                    xhr.send(file);
                });
            }

            async function pollProcessingStatus(jobId) {
                try {
                    const res = await fetch(statusUrlBase + jobId);
                    if (!res.ok) throw new Error('Failed to get status');
                    const data = await res.json();
                    if (data.status === 'completed') {
                        statusMessage.textContent = 'Processing completed!';
                        processingStage.textContent = '';
                        progressBarContainer.style.display = 'none';
                        const base = (data.original_filename || 'output.wav').split('.').slice(0, -1).join('.');
                        const fname = base + '_final_audiopuff.wav';
                        const link = document.getElementById('downloadLink');
                        link.href = downloadUrlBase + jobId;
                        link.download = fname;
                        link.textContent = `Download ${fname}`;
                        resultContainer.style.display = 'block';
                        resetUploadButton();
                    } else if (data.status === 'failed') {
                        statusMessage.textContent = 'Processing failed.';
                        processingStage.textContent = `Error: ${data.error || 'Unknown'}`;
                        resetUploadButton();
                        progressBarContainer.style.display = 'none';
                    } else {
                        statusMessage.textContent = 'Processing audio file...';
                        processingStage.textContent = data.status.replace(/_/g,' ');
                        setTimeout(() => pollProcessingStatus(jobId), 5000);
                    }
                } catch (err) {
                    statusMessage.textContent = `Error checking status: ${err.message}`;
                    resetUploadButton();
                    progressBarContainer.style.display = 'none';
                }
            }

            function resetUI() {
                statusMessage.textContent = '';
                processingStage.textContent = '';
                resultContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.textContent = '';
            }
            function resetUploadButton() {
                uploadButton.disabled = false;
                uploadButton.value = 'Upload and Process';
            }
        });
    </script>
</body>
</html>
